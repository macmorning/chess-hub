/*! chess-hub 2013-04-29 */
var CHESSBOARD={chessBoardColumns:{1:"a",2:"b",3:"c",4:"d",5:"e",6:"f",7:"g",8:"h"},chessBoardRows:[8,7,6,5,4,3,2,1],colors:{w:"white",b:"black"},pieces:[],gameID:"",selectedPiece:"",playerA:"",playerB:"",blackPlayer:"",blackCanCastleKingSide:!0,blackCanCastleQueenSide:!0,whitePlayer:"",whiteCanCastleKingSide:!0,whiteCanCastleQueenSide:!0,currentGameTurn:"",gameHistory:[],chessBoard:{11:"",12:"",13:"",14:"",15:"",16:"",17:"",18:"",21:"",22:"",23:"",24:"",25:"",26:"",27:"",28:"",31:"",32:"",33:"",34:"",35:"",36:"",37:"",38:"",41:"",42:"",43:"",44:"",45:"",46:"",47:"",48:"",51:"",52:"",53:"",54:"",55:"",56:"",57:"",58:"",61:"",62:"",63:"",64:"",65:"",66:"",67:"",68:"",71:"",72:"",73:"",74:"",75:"",76:"",77:"",78:"",81:"",82:"",83:"",84:"",85:"",86:"",87:"",88:""},numericColumns:{a:10,b:20,c:30,d:40,e:50,f:60,g:70,h:80},unnumericColumns:{1:"a",2:"b",3:"c",4:"d",5:"e",6:"f",7:"g",8:"h"},_numeric:function(e){var s=parseInt(CHESSBOARD.numericColumns[e[2]],10)+parseInt(e[3],10);return s},_unnumeric:function(e){var s=e+"";return"sq"+CHESSBOARD.unnumericColumns[s[0]]+s[1]},_markSquare:function(e,s,S){if(S){try{$("#"+e).addClass(s)}catch(a){return console.log(e+" cannot be marked as checked."),!1}return!0}try{$("#"+e).removeClass(s)}catch(a){return console.log(e+" cannot be unmarked as checked."),!1}return!0},move:function(e,s){"wking"===e.attr("id")?(CHESSBOARD.whiteCanCastleKingSide=!1,CHESSBOARD.whiteCanCastleQueenSide=!1):"bking"===e.attr("id")?(CHESSBOARD.blackCanCastleKingSide=!1,CHESSBOARD.blackCanCastleQueenSide=!1):"wrooka"===e.attr("id")?CHESSBOARD.whiteCanCastleQueenSide=!1:"wrookh"===e.attr("id")?CHESSBOARD.whiteCanCastleKingSide=!1:"brooka"===e.attr("id")?CHESSBOARD.blackCanCastleQueenSide=!1:"brookh"===e.attr("id")&&(CHESSBOARD.blackCanCastleKingSide=!1),CHESSBOARD.chessBoard[CHESSBOARD._numeric(CHESSBOARD.pieces[e.attr("id")].sqId)]="","s"===s.attr("id")[0]&&(CHESSBOARD.chessBoard[CHESSBOARD._numeric(s.attr("id"))]=CHESSBOARD.pieces[e.attr("id")].id),CHESSBOARD._verifyCheck();var S=.05*s.width();e.animate({top:"+="+(s.position().top-e.position().top)+"px",left:"+="+(s.position().left-e.position().left+S)+"px"},"slow",void 0,function(){e.prependTo(s),e.css({top:"0px",left:"0px"})}),CHESSBOARD.pieces[e.attr("id")].sqId=s.attr("id"),"wGraveyard"!==s.attr("id")&&"bGraveyard"!==s.attr("id")&&(CHESSBOARD.gameHistory.push(e.attr("id")+"-"+s.attr("id")),CHESSBOARD.currentGameTurn="w"===CHESSBOARD.currentGameTurn?"b":"w")},flip:function(){var e={1:CHESSBOARD.chessBoardColumns[8],2:CHESSBOARD.chessBoardColumns[7],3:CHESSBOARD.chessBoardColumns[6],4:CHESSBOARD.chessBoardColumns[5],5:CHESSBOARD.chessBoardColumns[4],6:CHESSBOARD.chessBoardColumns[3],7:CHESSBOARD.chessBoardColumns[2],8:CHESSBOARD.chessBoardColumns[1]};CHESSBOARD.chessBoardColumns=e,CHESSBOARD.chessBoardRows.reverse(),$("#chessBoard").empty(),$("#wGraveyard").empty(),$("#bGraveyard").empty(),CHESSBOARD._drawBoard(),CHESSBOARD._spawnPieces()},mouseDownHandler:function(e){if(e.stopPropagation(),"IMG"===e.target.tagName&&!CHESSBOARD.selectedPiece&&(e.target.id[0]!==CHESSBOARD.currentGameTurn||"wGraveyard"===CHESSBOARD.pieces[e.target.id].sqId||"bGraveyard"===CHESSBOARD.pieces[e.target.id].sqId||"w"===e.target.id[0]&&CHESSBOARD.whitePlayer!==CONTEXT.user||"b"===e.target.id[0]&&CHESSBOARD.blackPlayer!==CONTEXT.user))return 0;if("IMG"!==e.target.tagName||CHESSBOARD.selectedPiece)if("IMG"===e.target.tagName&&CHESSBOARD.selectedPiece&&CHESSBOARD.selectedPiece.attr("id")!==e.target.id&&CHESSBOARD.selectedPiece.attr("id")[0]===e.target.id[0])CHESSBOARD._markSquare(CHESSBOARD.pieces[CHESSBOARD.selectedPiece.attr("id")].sqId,"selected",!1),CHESSBOARD.selectedPiece=$("#"+e.target.id),CHESSBOARD._markSquare(CHESSBOARD.pieces[e.target.id].sqId,"selected",!0);else if("IMG"===e.target.tagName&&CHESSBOARD.selectedPiece&&CHESSBOARD.selectedPiece.attr("id")===e.target.id)CHESSBOARD._markSquare(CHESSBOARD.pieces[CHESSBOARD.selectedPiece.attr("id")].sqId,"selected",!1),CHESSBOARD.selectedPiece="";else if(("DIV"===e.target.tagName||"IMG"===e.target.tagName&&CHESSBOARD.selectedPiece.attr("id")[0]!==e.target.id[0]&&""!==CHESSBOARD.pieces[e.target.id].sqId)&&CHESSBOARD.selectedPiece){for(var s=e.target;"DIV"!==s.tagName;)s=s.parentNode;if(!CHESSBOARD._canMove(CHESSBOARD.selectedPiece.attr("id"),s.id))return 1;var S=function(){},a=CHESSBOARD.chessBoard[CHESSBOARD._numeric(s.id)];if(""!==a){var r=$("#"+a),i=$("#"+CHESSBOARD.pieces[a].id[0]+"Graveyard");CHESSBOARD.move(r,i),CHESSHUB.sendMessage("move-"+r.attr("id")+"-"+i.attr("id"),CHESSBOARD.gameID,"game",S,S)}CHESSBOARD._markSquare(CHESSBOARD.pieces[CHESSBOARD.selectedPiece.attr("id")].sqId,"selected",!1),CHESSBOARD.move(CHESSBOARD.selectedPiece,$("#"+s.id)),CHESSHUB.sendMessage("move-"+CHESSBOARD.selectedPiece.attr("id")+"-"+s.id,CHESSBOARD.gameID,"game",S,S),CHESSBOARD.selectedPiece=""}else console.log("Unhandled case : "+e.target.id);else CHESSBOARD.selectedPiece=$("#"+e.target.id),CHESSBOARD._markSquare(CHESSBOARD.pieces[e.target.id].sqId,"selected",!0)},_canMove:function(e,s){window.document.getElementById(s);var S="",a=0,r="",S=CHESSBOARD.chessBoard[CHESSBOARD._numeric(s)],i=CHESSBOARD.pieces[e].sqId,t=parseInt(CHESSBOARD._numeric(i),10),n=parseInt(CHESSBOARD._numeric(s),10),c=n-t;switch(CHESSBOARD.pieces[e].type){case"pawn":return"w"===e[0]&&(1===c||2===c&&"2"===i[3])?S?!1:2===c&&CHESSBOARD.chessBoard[t+1]?!1:!0:"b"===e[0]&&(-1===c||-2===c&&"7"===i[3])?S?!1:-2===c&&CHESSBOARD.chessBoard[t-1]?!1:!0:"w"===e[0]&&(11===c||-9===c)||"b"===e[0]&&(-11===c||9===c)?S?!0:!1:!1;case"knight":return 21===c||-21===c||19===c||-19===c||12===c||-12===c||8===c||-8===c?!0:!1;case"bishop":if(0===c%11&&c>0&&parseInt(i[3],10)<parseInt(s[3],10)&&i[2]<s[2]||0===c%11&&0>c&&parseInt(i[3],10)>parseInt(s[3],10)&&i[2]>s[2]||0===c%9&&c>0&&parseInt(i[3],10)>parseInt(s[3],10)&&i[2]<s[2]||0===c%9&&0>c&&parseInt(i[3],10)<parseInt(s[3],10)&&i[2]>s[2]){for(0===c%11&&c>0?a=11:0===c%11&&0>c?a=-11:0===c%9&&c>0?a=9:0===c%9&&0>c&&(a=-9),r=t+a;n>r&&c>0||r>n&&0>c;r+=a)if(CHESSBOARD.chessBoard[r])return!1;return!0}return!1;case"rook":if(i[2]===s[2]||i[3]===s[3]){for(i[2]===s[2]&&c>0?a=1:i[2]===s[2]&&0>c?a=-1:i[3]===s[3]&&c>0?a=10:i[3]===s[3]&&0>c&&(a=-10),r=t+a;n>r&&c>0||r>n&&0>c;r+=a)if(CHESSBOARD.chessBoard[r])return!1;return!0}break;case"queen":if(0===c%11&&c>0&&parseInt(i[3],10)<parseInt(s[3],10)&&i[2]<s[2]||0===c%11&&0>c&&parseInt(i[3],10)>parseInt(s[3],10)&&i[2]>s[2]||0===c%9&&c>0&&parseInt(i[3],10)>parseInt(s[3],10)&&i[2]<s[2]||0===c%9&&0>c&&parseInt(i[3],10)<parseInt(s[3],10)&&i[2]>s[2]||i[2]===s[2]||i[3]===s[3]){for(0===c%11&&c>0?a=11:0===c%11&&0>c?a=-11:0===c%9&&c>0?a=9:0===c%9&&0>c?a=-9:i[2]===s[2]&&c>0?a=1:i[2]===s[2]&&0>c?a=-1:i[3]===s[3]&&c>0?a=10:i[3]===s[3]&&0>c&&(a=-10),r=t+a;n>r&&c>0||r>n&&0>c;r+=a)if(CHESSBOARD.chessBoard[r])return!1;return!0}break;case"king":if(a=0,1===c||-1===c||-11===c||11===c||-9===c||9===c||-10===c||10===c)return!0;if(CHESSBOARD._isCheck(e,i)||CHESSBOARD._isCheck(e,s))return!1;if(20===c&&CHESSBOARD.whiteCanCastleKingSide&&"w"===e[0]?a=10:20===c&&CHESSBOARD.blackCanCastleKingSide&&"b"===e[0]?a=10:-20===c&&CHESSBOARD.whiteCanCastleQueenSide&&"w"===e[0]?a=-10:-20===c&&CHESSBOARD.blackCanCastleQueenSide&&"b"===e[0]&&(a=-10),!a)return!1;for(r=t+a;n>=r&&c>0||r>=n&&0>c;r+=a)if(CHESSBOARD.chessBoard[r])return!1;return!0}return!1},_isCheck:function(e,s){if("wking"!==e&&"bking"!==e)return!1;for(var S in CHESSBOARD.pieces)if("king"!==CHESSBOARD.pieces[S].type&&"s"===CHESSBOARD.pieces[S].sqId[0]&&S[0]!==e[0]&&CHESSBOARD._canMove(S,s))return console.log(e+" checked at square "+s+" by "+S),!0;return!1},_verifyCheck:function(){var e=["bking","wking"];return e.forEach(function(e){CHESSBOARD._isCheck(e,CHESSBOARD.pieces[e].sqId)?(CHESSBOARD._markSquare(CHESSBOARD.pieces[e].sqId,"check",!0),console.log(e+" is check")):CHESSBOARD._markSquare(CHESSBOARD.pieces[e].sqId,"check",!1)}),!1},_createPieces:function(){for(var e in CHESSBOARD.colors){CHESSBOARD.pieces[e+"king"]={id:e+"king",type:"king",order:0,name:CHESSBOARD.colors[e]+" king","class":e+"king",sqId:"sqe"+("w"===e?1:8),initx:5,inity:"w"===e?1:8},CHESSBOARD.pieces[e+"queen"]={id:e+"queen",type:"queen",order:1,name:CHESSBOARD.colors[e]+" queen","class":e+"queen",sqId:"sqd"+("w"===e?1:8),initx:4,inity:"w"===e?1:8},CHESSBOARD.pieces[e+"rooka"]={id:e+"rooka",type:"rook",order:2,name:CHESSBOARD.colors[e]+" rook (a)","class":e+"rook",sqId:"sqa"+("w"===e?1:8),initx:1,inity:"w"===e?1:8},CHESSBOARD.pieces[e+"rookh"]={id:e+"rookh",type:"rook",order:3,name:CHESSBOARD.colors[e]+" rook (h)","class":e+"rook",sqId:"sqh"+("w"===e?1:8),initx:8,inity:"w"===e?1:8},CHESSBOARD.pieces[e+"knightb"]={id:e+"knightb",type:"knight",order:4,name:CHESSBOARD.colors[e]+" knight (b)","class":e+"knight",sqId:"sqb"+("w"===e?1:8),initx:2,inity:"w"===e?1:8},CHESSBOARD.pieces[e+"knightg"]={id:e+"knightg",type:"knight",order:2,name:CHESSBOARD.colors[e]+" knight (g)","class":e+"knight",sqId:"sqg"+("w"===e?1:8),initx:7,inity:"w"===e?1:8},CHESSBOARD.pieces[e+"bishopc"]={id:e+"bishopc",type:"bishop",order:6,name:CHESSBOARD.colors[e]+" bishop (c)","class":e+"bishop",sqId:"sqc"+("w"===e?1:8),initx:3,inity:"w"===e?1:8},CHESSBOARD.pieces[e+"bishopf"]={id:e+"bishopf",type:"bishop",order:7,name:CHESSBOARD.colors[e]+" bishop (f)","class":e+"bishop",sqId:"sqf"+("w"===e?1:8),initx:6,inity:"w"===e?1:8};for(var s in CHESSBOARD.chessBoardColumns)CHESSBOARD.pieces[e+"pawn"+CHESSBOARD.chessBoardColumns[s]]={id:e+"pawn"+CHESSBOARD.chessBoardColumns[s],type:"pawn",order:7+s,name:CHESSBOARD.colors[e]+" pawn ("+CHESSBOARD.chessBoardColumns[s]+")","class":e+"pawn",sqId:"sq"+CHESSBOARD.chessBoardColumns[s]+("w"===e?2:7),initx:s,inity:"w"===e?2:7}}CHESSBOARD.chessBoard={11:"",12:"",13:"",14:"",15:"",16:"",17:"",18:"",21:"",22:"",23:"",24:"",25:"",26:"",27:"",28:"",31:"",32:"",33:"",34:"",35:"",36:"",37:"",38:"",41:"",42:"",43:"",44:"",45:"",46:"",47:"",48:"",51:"",52:"",53:"",54:"",55:"",56:"",57:"",58:"",61:"",62:"",63:"",64:"",65:"",66:"",67:"",68:"",71:"",72:"",73:"",74:"",75:"",76:"",77:"",78:"",81:"",82:"",83:"",84:"",85:"",86:"",87:"",88:""};for(var S in CHESSBOARD.pieces)CHESSBOARD.chessBoard[CHESSBOARD._numeric(CHESSBOARD.pieces[S].sqId)]=CHESSBOARD.pieces[S].id},_spawnPieces:function(){var e=$("#bGraveyard"),s=$("#wGraveyard");for(var S in CHESSBOARD.pieces){var a='<img                         class="piece '+CHESSBOARD.pieces[S].class+'"                         src="/client/img/transparent.png"                         alt="'+CHESSBOARD.pieces[S].name+'"                         title="'+CHESSBOARD.pieces[S].name+'"                         id="'+CHESSBOARD.pieces[S].id+'">                   </img>';"w"===CHESSBOARD.pieces[S].id[0]&&""===CHESSBOARD.pieces[S].sqId?s.append(a):"b"===CHESSBOARD.pieces[S].id[0]&&""===CHESSBOARD.pieces[S].sqId?e.append(a):$("#"+CHESSBOARD.pieces[S].sqId).append(a)}$(".piece").bind("vmousedown",function(e){CHESSBOARD.mouseDownHandler(e)}).on("dragstart",function(e){e.preventDefault()})},_drawBoard:function(){var e=$("#chessBoard");for(var s in CHESSBOARD.chessBoardRows){var S='<div class="chessBoardRow">';for(var a in CHESSBOARD.chessBoardColumns)S+='<div title="'+CHESSBOARD.chessBoardColumns[a]+CHESSBOARD.chessBoardRows[s]+'"                             id="sq'+CHESSBOARD.chessBoardColumns[a]+CHESSBOARD.chessBoardRows[s]+'"                             class="chessBoardSquare chessBoardSquare'+(parseInt(a,10)+parseInt(s,10))%2+'"></div>';S+="</div>",e.append(S)}$(".chessBoardSquare").bind("vmousedown",function(e){CHESSBOARD.mouseDownHandler(e)})},initChessBoard:function(e){return CHESSBOARD.pieces=[],$("#chessBoard").empty(),$("#wGraveyard").empty(),$("#bGraveyard").empty(),$("#wSit").css("display","block"),$("#bSit").css("display","block"),CHESSBOARD._drawBoard(),CHESSBOARD._createPieces(),CHESSBOARD._spawnPieces(),CHESSBOARD.gameID=e,CHESSBOARD.playerA="",CHESSBOARD.playerB="",CHESSBOARD.blackPlayer="",CHESSBOARD.blackCanCastleKingSide=!0,CHESSBOARD.blackCanCastleQueenSide=!0,CHESSBOARD.whitePlayer="",CHESSBOARD.whiteCanCastleKingSide=!0,CHESSBOARD.whiteCanCastleQueenSide=!0,CHESSBOARD.currentGameTurn="",CHESSBOARD.gameHistory=[],0},sit:function(e){return $("#"+e+"Sit").css("display","none"),CHESSHUB.sendMessage("sit-"+e,CHESSBOARD.gameID,"game",function(){CHESSBOARD.setPlayer(e,CONTEXT.user)},function(){console.log("error while sitting")}),0},setPlayer:function(e,s){console.log("setPlayer : "+e+"="+s),"A"===e?CHESSBOARD.playerA=s:"B"===e?CHESSBOARD.playerB=s:"w"===e?(CHESSBOARD.whitePlayer=s,s?$("#wSit").css("display","none"):$("#wSit").css("display","block")):"b"===e&&(CHESSBOARD.blackPlayer=s,s?$("#bSit").css("display","none"):$("#bSit").css("display","block")),CHESSBOARD.blackPlayer&&CHESSBOARD.whitePlayer&&(CHESSBOARD.currentGameTurn||(CHESSBOARD.currentGameTurn="w"))}};