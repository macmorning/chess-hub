/*! chess-hub 2014-04-17 */
CHESSHUB={name:"chessHubClient",version:"0.1",user:"",key:"",channels:[],ajaxPoll:{},ajaxSearchGame:{},init:function(){CHESSHUB.user&&CHESSHUB.disconnect(function(){},function(){}),CHESSHUB._abortAjaxCalls(),CHESSHUB.user="",CHESSHUB.key="",CHESSHUB.channels=[]},_abortAjaxCalls:function(){try{CHESSHUB.ajaxPoll.abort()}catch(a){}try{CHESSHUB.ajaxSearchGame.abort()}catch(a){}},_poll:function(a,b,c){if(!CHESSHUB.channels[a]||CHESSHUB.channels[a].counter.isNaN)return!1;var d={user:CHESSHUB.user,key:CHESSHUB.key,counter:CHESSHUB.channels[a].counter,channel:a};CHESSHUB.ajaxPoll=$.ajax({type:"POST",url:"/poll",contentType:"application/json; charset=utf-8",dataType:"json",data:JSON.stringify(d),success:function(d){isNaN(d.counter)?console.log("CHESSHUB._poll : error - unexpected answer"):CHESSHUB.channels[a].counter=d.counter,$.isArray(d.append)?d.append.forEach(function(a){b(a,d.newMsg,d.whiteTimer,d.blackTimer,d.counter)}):b(d.append,d.newMsg,d.whiteTimer,d.blackTimer,d.counter),c(d.users),CHESSHUB._poll(a,b,c)},error:function(d,e,f){console.log("CHESSHUB._poll : error - "+e),console.log(f),"Bad Request"!==f&&setTimeout(function(){CHESSHUB._poll(a,b,c)},1e4)}})},listUsers:function(){console.log("CHESSHUB.listUsers")},searchGame:function(a,b,c,d,e,f,g){var h={user:CHESSHUB.user,key:CHESSHUB.key,playerLevel:a,playerAcceptLower:b,playerAcceptHigher:c,playerTimerPref:d,createFlag:e};CHESSHUB.ajaxSearchGame=$.ajax({type:"POST",url:"/searchGame",contentType:"application/json; charset=utf-8",dataType:"json",data:JSON.stringify(h),success:function(a){f(a)},error:function(a,b,c){console.log("CHESSHUB.searchGame : error - "+b),console.log(c),g()}})},listen:function(a,b,c){CHESSHUB.channels[a]={counter:0,name:a,history:[]},b&&Object.getPrototypeOf(b)===Function.prototype||(console.log("listen : no handler provided for message"),b=function(){console.log("listen : no handler provided for message")}),c&&Object.getPrototypeOf(c)===Function.prototype||(console.log("users list : no handler provided for users"),b=function(){console.log("users list : no handler provided for users")}),this._poll(a,b,c)},leave:function(a){console.log("leaving channel "+a),CHESSHUB._abortAjaxCalls(),CHESSHUB.channels[a]={};var b={user:CHESSHUB.user,key:CHESSHUB.key,gameId:a};$.ajax({type:"POST",url:"/leave",contentType:"application/json; charset=utf-8",dataType:"json",data:JSON.stringify(b),error:function(a,b,c){console.log("CHESSHUB.leave error - "+b),console.log(c)}})},connect:function(a,b,c,d){CHESSHUB.init();var e={user:a,key:b,clientLib:CHESSHUB.name,clientVersion:CHESSHUB.version};$.ajax({type:"POST",url:"/connect",contentType:"application/json; charset=utf-8",dataType:"json",data:JSON.stringify(e),success:function(a){"ok"===a.returncode&&(CHESSHUB.user=a.user,CHESSHUB.key=a.key),c(a)},error:function(a,b,c){console.log("CHESSHUB.connect error - "+b),console.log(c),d()}})},disconnect:function(){if(!CHESSHUB.user)return!1;var a={user:CHESSHUB.user,key:CHESSHUB.key};CHESSHUB.channels=[],$.ajax({type:"POST",url:"/disconnect",contentType:"application/json; charset=utf-8",dataType:"json",data:JSON.stringify(a),success:function(){},error:function(a,b,c){console.log("CHESSHUB.disconnect error - "+b),console.log(c)}})},sendMessage:function(a,b,c,d,e){if(!CHESSHUB.user)return void console.log("CHESSHUB.sendMessage error - Not connected");b||(b="MAIN"),c||(c="chat_msg");var f={user:CHESSHUB.user,channel:b,key:CHESSHUB.key,msg:a,category:c};$.ajax({type:"POST",url:"/msg",contentType:"application/json; charset=utf-8",dataType:"json",data:JSON.stringify(f),success:function(){d()},error:function(a,b,c){console.log("CHESSHUB.sendMessage error - "+b),console.log(c),e()}})},getStats:function(a,b){var c={user:CHESSHUB.user,key:CHESSHUB.key};$.ajax({type:"POST",url:"/stats",contentType:"application/json; charset=utf-8",dataType:"json",data:JSON.stringify(c),success:function(b){a(b)},error:function(a,c,d){console.log("CHESSHUB.getStats error - "+c),console.log(d),b()}})},joinGame:function(a,b,c){var d={user:CHESSHUB.user,key:CHESSHUB.key,gameId:a};$.ajax({type:"POST",url:"/getGame",contentType:"application/json; charset=utf-8",dataType:"json",data:JSON.stringify(d),success:function(a){b(a)},error:function(a,b,d){console.log("CHESSHUB.joinGame error - "+b),console.log(d),c()}})}};