/*! chess-hub 2013-05-08 */
CHESSHUB={name:"chessHubClient",version:"0.1",user:"",key:"",channels:[],ajaxPoll:{},ajaxSearchGame:{},init:function(){CHESSHUB.user&&CHESSHUB.disconnect(function(){},function(){}),CHESSHUB._abortAjaxCalls(),CHESSHUB.user="",CHESSHUB.key="",CHESSHUB.channels=[]},_abortAjaxCalls:function(){try{CHESSHUB.ajaxPoll.abort()}catch(e){}try{CHESSHUB.ajaxSearchGame.abort()}catch(e){}},_poll:function(e,S){if(!CHESSHUB.channels[e]||CHESSHUB.channels[e].counter.isNaN)return console.log("CHESSHUB._poll : "+e+" is not a known channel"),!1;console.log("polling ... "+CHESSHUB.channels[e].counter);var s={user:CHESSHUB.user,key:CHESSHUB.key,counter:CHESSHUB.channels[e].counter,channel:e};CHESSHUB.ajaxPoll=$.ajax({type:"POST",url:"/poll",contentType:"application/json; charset=utf-8",dataType:"json",data:JSON.stringify(s),success:function(s){isNaN(s.counter)?(console.log("CHESSHUB._poll : error - unexpected answer"),console.log(s)):CHESSHUB.channels[e].counter=s.counter,$.isArray(s.append)?s.append.forEach(function(e){S(e)}):S(s.append),CHESSHUB._poll(e,S)},error:function(s,a,r){console.log("CHESSHUB._poll : error - "+a),console.log(r),"Bad Request"!==r&&setTimeout(function(){CHESSHUB._poll(e,S)},1e4)}})},listUsers:function(){console.log("CHESSHUB.listUsers")},searchGame:function(e,S,s,a,r,n,o){console.log("CHESSHUB.searchGame");var i={user:CHESSHUB.user,key:CHESSHUB.key,playerLevel:e,playerAcceptLower:S,playerAcceptHigher:s,playerTimerPref:a,createFlag:r};console.log(i),CHESSHUB.ajaxSearchGame=$.ajax({type:"POST",url:"/searchGame",contentType:"application/json; charset=utf-8",dataType:"json",data:JSON.stringify(i),success:function(e){console.log("CHESSHUB.searchGame : answer : "),console.log(e),n(e)},error:function(e,S,s){console.log("CHESSHUB.searchGame : error - "+S),console.log(s),o()}})},listen:function(e,S){CHESSHUB.channels[e]={counter:0,name:e,history:[]},S&&Object.getPrototypeOf(S)===Function.prototype||(console.log("listen : no handler provided for message"),S=function(){console.log("listen : no handler provided for message")}),this._poll(e,S)},leave:function(e){console.log("leaving channel "+e),CHESSHUB._abortAjaxCalls(),CHESSHUB.channels[e]={}},connect:function(e,S,s){CHESSHUB.init();var a={user:e,clientLib:CHESSHUB.name,clientVersion:CHESSHUB.version};$.ajax({type:"POST",url:"/connect",contentType:"application/json; charset=utf-8",dataType:"json",data:JSON.stringify(a),success:function(e){"ok"===e.returncode&&(CHESSHUB.user=e.user,CHESSHUB.key=e.key),S(e)},error:function(e,S,a){console.log("CHESSHUB.connect error - "+S),console.log(a),s()}})},disconnect:function(){if(!CHESSHUB.user)return!1;var e={user:CHESSHUB.user,key:CHESSHUB.key};console.log("CHESSHUB.disconnect : leaving all channels"),CHESSHUB.channels=[],$.ajax({type:"POST",url:"/disconnect",contentType:"application/json; charset=utf-8",dataType:"json",data:JSON.stringify(e),success:function(){console.log("CHESSHUB.disconnect : ... ok")},error:function(e,S,s){console.log("CHESSHUB.disconnect error - "+S),console.log(s)}})},sendMessage:function(e,S,s,a,r){if(!CHESSHUB.user)return console.log("CHESSHUB.sendMessage error - Not connected"),void 0;S||(S="MAIN"),s||(s="chat_msg");var n={user:CHESSHUB.user,channel:S,key:CHESSHUB.key,msg:e,category:s};$.ajax({type:"POST",url:"/msg",contentType:"application/json; charset=utf-8",dataType:"json",data:JSON.stringify(n),success:function(){a()},error:function(e,S,s){console.log("CHESSHUB.sendMessage error - "+S),console.log(s),r()}})},getStats:function(e,S){var s={user:CHESSHUB.user,key:CHESSHUB.key};$.ajax({type:"POST",url:"/stats",contentType:"application/json; charset=utf-8",dataType:"json",data:JSON.stringify(s),success:function(S){e(S)},error:function(e,s,a){console.log("CHESSHUB.getStats error - "+s),console.log(a),S()}})},joinGame:function(e,S,s){var a={user:CHESSHUB.user,key:CHESSHUB.key,gameId:e};$.ajax({type:"POST",url:"/getGame",contentType:"application/json; charset=utf-8",dataType:"json",data:JSON.stringify(a),success:function(e){S(e)},error:function(e,S,a){console.log("CHESSHUB.joinGame error - "+S),console.log(a),s()}})}};